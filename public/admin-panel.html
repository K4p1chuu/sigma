<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - WSP MDT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { display: none; }
        .modal-backdrop.flex { display: flex; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen">

    <aside id="sidebar-container" class="w-64 bg-gray-800 p-4 flex flex-col min-h-screen flex-shrink-0"></aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <div id="admin-content">
            <h1 class="text-3xl font-bold text-white mb-6">Zarządzanie MDT</h1>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Sekcja Zarządzania Funkcjonariuszami -->
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">Zarządzanie Funkcjonariuszami</h2>
                        <button id="add-user-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                            <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>Dodaj Funkcjonariusza
                        </button>
                    </div>
                    <div id="add-user-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">Nowy Funkcjonariusz</h2>
                        <form id="add-user-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="email" name="email" placeholder="Email (do logowania)" class="bg-gray-700 rounded p-2" required>
                                <input type="text" name="username" placeholder="Imię i Nazwisko" class="bg-gray-700 rounded p-2" required>
                                <input type="password" name="password" placeholder="Hasło" class="bg-gray-700 rounded p-2" required>
                                <input type="text" name="badge" placeholder="Odznaka" class="bg-gray-700 rounded p-2" required>
                                <input type="text" name="robloxId" placeholder="ID Gracza (Roblox)" class="bg-gray-700 rounded p-2" required>
                                <input type="text" name="discordNick" placeholder="Nick Discord" class="bg-gray-700 rounded p-2" required>
                                <input type="text" name="robloxNick" placeholder="Nick Roblox" class="bg-gray-700 rounded p-2" required>
                                <input type="date" name="joinedAt" title="Data dołączenia" class="bg-gray-700 rounded p-2" required>
                                <select name="rank" class="bg-gray-700 rounded p-2" required>
                                    <!-- Opcje rang generowane dynamicznie -->
                                </select>
                                <select name="isAdmin" class="bg-gray-700 rounded p-2">
                                    <option value="false">Użytkownik</option>
                                    <option value="true">Administrator</option>
                                </select>
                            </div>
                            <div class="flex justify-end gap-4">
                                <button type="button" id="cancel-add-user" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Anuluj</button>
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Zapisz</button>
                            </div>
                        </form>
                        <p id="add-user-message" class="text-center mt-4 h-4"></p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">Lista Funkcjonariuszy</h2>
                        <div class="overflow-auto max-h-96">
                            <table class="min-w-full text-sm text-left text-gray-300">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3">Nazwa</th>
                                        <th class="px-6 py-3">Ranga</th>
                                        <th class="px-6 py-3 text-right">Akcje</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sekcja Zarządzania Ogłoszeniami -->
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">Zarządzanie Ogłoszeniami</h2>
                        <form id="announcement-form" class="space-y-3">
                             <input type="text" id="announcement-title" placeholder="Tytuł ogłoszenia" class="w-full bg-gray-700 rounded p-2" required>
                             <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg">Dodaj Ogłoszenie</button>
                        </form>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">Aktualne Ogłoszenia</h2>
                        <div id="announcements-list" class="overflow-auto max-h-96 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Edycji -->
    <div id="edit-user-modal" class="modal-backdrop fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 z-50 justify-center items-center">
         <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 class="text-lg font-medium leading-6 text-white mb-4">Edytuj Funkcjonariusza</h3>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="editUserEmail">
                <div>
                    <label class="text-sm font-medium text-gray-400">Odznaka</label>
                    <input type="text" id="editUserBadge" class="w-full bg-gray-700 rounded p-2 mt-1" required>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-400">Ranga</label>
                    <select id="editUserRank" class="w-full bg-gray-700 rounded p-2 mt-1" required></select>
                </div>
                 <div>
                    <label class="text-sm font-medium text-gray-400">ID Gracza (Roblox)</label>
                    <input type="text" id="editUserRobloxId" class="w-full bg-gray-700 rounded p-2 mt-1" required>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-400">Nick Discord</label>
                    <input type="text" id="editUserDiscordNick" class="w-full bg-gray-700 rounded p-2 mt-1" required>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-400">Nick Roblox</label>
                    <input type="text" id="editUserRobloxNick" class="w-full bg-gray-700 rounded p-2 mt-1" required>
                </div>
                 <div>
                    <label class="text-sm font-medium text-gray-400">Data dołączenia</label>
                    <input type="date" id="editUserJoinedAt" class="w-full bg-gray-700 rounded p-2 mt-1" required>
                </div>
                <p id="edit-user-message" class="text-center h-4"></p>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="edit-cancel-button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Anuluj</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Zapisz Zmiany</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Potwierdzenia Usunięcia -->
    <div id="confirm-modal" class="modal-backdrop fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 z-50 justify-center items-center">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 id="confirm-modal-title" class="text-lg font-medium leading-6 text-white">Potwierdź akcję</h3>
            <p id="confirm-modal-text" class="mt-2 text-sm text-gray-400">Czy na pewno chcesz kontynuować?</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" id="confirm-cancel-button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Anuluj</button>
                <button type="button" id="confirm-danger-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Potwierdź</button>
            </div>
        </div>
    </div>

    <script src="shared.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const userData = await loadSidebarAndUserData('admin-panel');
        if(!userData || !userData.isAdmin) {
            document.getElementById('admin-content').innerHTML = '<h1 class="text-3xl font-bold text-red-500">Brak uprawnień do tej strony.</h1>';
            return;
        }
        
        const token = localStorage.getItem('mdt-token');
        const rankOrder = [ 'Chief of Police', 'Deputy Chief of Police', 'Assistant Chief of Police', 'Commander', 'Captain', 'Lieutenant', 'Staff Sergeant', 'Senior Sergeant', 'Sergeant', 'Senior Trooper', 'Trooper', 'Trooper Trainee' ];

        const tableBody = document.getElementById('users-table-body');
        const addUserButton = document.getElementById('add-user-button');
        const addUserFormContainer = document.getElementById('add-user-form-container');
        const cancelAddUserButton = document.getElementById('cancel-add-user');
        const addUserForm = document.getElementById('add-user-form');
        const addUserMessage = document.getElementById('add-user-message');
        
        const editUserModal = document.getElementById('edit-user-modal');
        const editUserForm = document.getElementById('edit-user-form');
        const cancelEditButton = document.getElementById('edit-cancel-button');
        const editUserMessage = document.getElementById('edit-user-message');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmCancelButton = document.getElementById('confirm-cancel-button');
        const confirmDangerButton = document.getElementById('confirm-danger-button');
        let actionToConfirm = null;

        function populateRankSelects() {
            const rankSelects = document.querySelectorAll('select[name="rank"], #editUserRank');
            let optionsHtml = '<option value="">Wybierz rangę...</option>';
            rankOrder.forEach(rank => { optionsHtml += `<option value="${rank}">${rank}</option>`; });
            rankSelects.forEach(select => select.innerHTML = optionsHtml);
        }

        async function fetchUsers() {
            try {
                const response = await fetch('/api/officers', { headers: { 'Authorization': token } });
                const users = await response.json();
                tableBody.innerHTML = ''; 
                users.filter(u => u.username !== 'Administrator').forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-white">${user.username}</td>
                        <td class="px-6 py-4">${user.rank}</td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button data-user='${JSON.stringify(user)}' class="edit-btn font-medium text-blue-400 hover:underline">Edytuj</button>
                            <button data-email="${user.email}" class="delete-btn font-medium text-red-500 hover:underline">Usuń</button>
                        </td>`;
                    tableBody.appendChild(row);
                });
            } catch(e) { console.error("Błąd pobierania funkcjonariuszy:", e); }
        }

        function showConfirmModal(text, onConfirm) {
            confirmModalText.textContent = text;
            actionToConfirm = onConfirm;
            confirmModal.classList.add('flex');
        }

        confirmCancelButton.addEventListener('click', () => {
            confirmModal.classList.remove('flex');
            actionToConfirm = null;
        });

        confirmDangerButton.addEventListener('click', () => {
            if (typeof actionToConfirm === 'function') {
                actionToConfirm();
            }
            confirmModal.classList.remove('flex');
            actionToConfirm = null;
        });
        
        addUserButton.addEventListener('click', () => addUserFormContainer.classList.remove('hidden'));
        cancelAddUserButton.addEventListener('click', () => addUserFormContainer.classList.add('hidden'));

        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addUserMessage.textContent = 'Dodawanie...';
            const formData = new FormData(addUserForm);
            const newUser = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/officers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify(newUser)
                });
                const data = await response.json();
                if(!response.ok) throw new Error(data.message || 'Błąd serwera');

                addUserMessage.textContent = 'Dodano pomyślnie!';
                setTimeout(() => {
                   addUserFormContainer.classList.add('hidden');
                   addUserForm.reset();
                   addUserMessage.textContent = '';
                   fetchUsers();
                }, 1500);
            } catch(error) { addUserMessage.textContent = `Błąd: ${error.message}`; }
        });

        tableBody.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            const editBtn = e.target.closest('.edit-btn');

            if (deleteBtn) {
                const email = deleteBtn.dataset.email;
                showConfirmModal(`Czy na pewno chcesz usunąć funkcjonariusza ${email}?`, async () => {
                    try {
                        const response = await fetch(`/api/officers/${encodeURIComponent(email)}`, { method: 'DELETE', headers: { 'Authorization': token } });
                        if (!response.ok) {
                           const err = await response.json();
                           throw new Error(err.message || 'Błąd serwera');
                        }
                        await fetchUsers();
                    } catch (error) {
                        addUserMessage.textContent = `Błąd: ${error.message}`;
                        setTimeout(() => addUserMessage.textContent = '', 4000);
                    }
                });
            }
            
            if (editBtn) {
                const user = JSON.parse(editBtn.dataset.user);
                document.getElementById('editUserEmail').value = user.email;
                document.getElementById('editUserBadge').value = user.badge;
                document.getElementById('editUserRank').value = user.rank;
                document.getElementById('editUserRobloxId').value = user.robloxId || '';
                document.getElementById('editUserDiscordNick').value = user.discordNick || '';
                document.getElementById('editUserRobloxNick').value = user.robloxNick || '';
                const joinDate = user.joinedAt ? new Date(user.joinedAt).toISOString().split('T')[0] : '';
                document.getElementById('editUserJoinedAt').value = joinDate;
                editUserModal.classList.add('flex');
            }
        });
        
        cancelEditButton.addEventListener('click', () => editUserModal.classList.remove('flex'));
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editUserMessage.textContent = 'Zapisywanie...';
            const email = document.getElementById('editUserEmail').value;
            const updatedData = {
                badge: document.getElementById('editUserBadge').value,
                rank: document.getElementById('editUserRank').value,
                robloxId: document.getElementById('editUserRobloxId').value,
                discordNick: document.getElementById('editUserDiscordNick').value,
                robloxNick: document.getElementById('editUserRobloxNick').value,
                joinedAt: document.getElementById('editUserJoinedAt').value,
            };
            try {
                 const response = await fetch(`/api/officers/${encodeURIComponent(email)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify(updatedData)
                 });
                 if(!response.ok) {
                     const err = await response.json();
                     throw new Error(err.message || 'Błąd serwera');
                 }
                 editUserMessage.textContent = 'Zapisano!';
                 setTimeout(() => {
                    editUserModal.classList.remove('flex');
                    editUserMessage.textContent = '';
                    fetchUsers();
                 }, 1500);
            } catch (error) { 
                editUserMessage.textContent = `Błąd: ${error.message}`;
            }
        });
        
        const announcementForm = document.getElementById('announcement-form');
        const announcementTitleInput = document.getElementById('announcement-title');
        const announcementsList = document.getElementById('announcements-list');

        async function fetchAnnouncements() {
            const response = await fetch('/api/announcements', { headers: { 'Authorization': token } });
            const data = await response.json();
            announcementsList.innerHTML = data.length > 0 ? data.map(a => `
                <div class="bg-gray-900 p-2 rounded-md flex justify-between items-center">
                    <div><p class="font-semibold">${a.title}</p><p class="text-xs text-gray-400">Przez: ${a.author}</p></div>
                    <button data-id="${a.id}" class="delete-announcement-btn text-red-500 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                </div>
            `).join('') : '<p class="text-gray-500">Brak ogłoszeń.</p>';
            lucide.createIcons();
        }

        announcementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = announcementTitleInput.value.trim();
            if (title) {
                await fetch('/api/announcements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ title })
                });
                announcementTitleInput.value = '';
                fetchAnnouncements();
            }
        });

        announcementsList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-announcement-btn');
            if (deleteBtn) {
                showConfirmModal('Czy na pewno chcesz usunąć to ogłoszenie?', () => {
                    fetch(`/api/announcements/${deleteBtn.dataset.id}`, { method: 'DELETE', headers: { 'Authorization': token } })
                    .then(() => fetchAnnouncements());
                });
            }
        });

        populateRankSelects();
        fetchUsers();
        fetchAnnouncements();
    });
    </script>
</body>
</html>

